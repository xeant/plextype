generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin-arm64", "linux-arm64-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int             @id @default(autoincrement())
  uuid          String          @unique @default(cuid())
  accountId     String          @unique
  email_address String          @unique
  nickName      String          @unique
  password      String
  refreshToken  String?
  createdAt     DateTime        @default(now())
  updateAt      DateTime        @updatedAt
  isAdmin       Boolean?
  isManagers    Boolean?
  Comment       Comment[]
  documents     Document[]
  profile       Profile?
  userGroups    UserGroupUser[]
  Attachment    Attachment[]

  @@index([email_address], map: "idx_user_email")
  @@index([isAdmin], map: "idx_user_isAdmin")
}

model Profile {
  id           Int     @id @default(autoincrement())
  phone        String  @unique
  userId       Int     @unique
  profileImage String?
  user         User    @relation(fields: [userId], references: [id])
}

model UserGroup {
  id         Int             @id @default(autoincrement())
  groupName  String          @unique
  groupTitle String          @db.VarChar(45)
  groupDesc  String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  users      UserGroupUser[]
}

model UserGroupUser {
  id        Int       @id @default(autoincrement())
  groupId   Int
  userId    Int
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  group     UserGroup @relation(fields: [groupId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@unique([userId, groupId], name: "uniq_ugu_user_group")
  @@index([userId], map: "idx_ugu_user")
  @@index([groupId], map: "idx_ugu_group")
}

model Document {
  id             Int          @id @default(autoincrement())
  uuid           String?      @unique @default(cuid())
  categoryId     Int?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  published      Boolean?     @default(false)
  userId         Int?
  authorName     String?      @db.VarChar(45)
  authorPassword String?
  title          String?      @db.VarChar(255)
  content        String?
  isNotice       Boolean?     @default(false)
  isSecrets      Boolean?     @default(false)
  readCount      Int?         @default(0)
  commentCount   Int?         @default(0)
  voteCount      Int?         @default(0)
  resourceId     Int
  resourceType   String
  Comment        Comment[]
  category       Category?    @relation("DocumentCategory", fields: [categoryId], references: [id])
  user           User?        @relation(fields: [userId], references: [id])
  attachments    Attachment[]

  @@index([resourceType, resourceId], map: "idx_document_resource")
  @@index([categoryId], map: "idx_document_category")
  @@index([userId], map: "idx_document_user")
}

model Category {
  id           Int        @id @default(autoincrement())
  title        String     @db.VarChar(45)
  desc         String?
  color        String?    @db.VarChar(45)
  order        Int        @default(0)
  parentId     Int?
  resourceId   Int?
  resourceType String     @default("posts")
  parent       Category?  @relation("CategoryChildren", fields: [parentId], references: [id])
  children     Category[] @relation("CategoryChildren")
  documents    Document[] @relation("DocumentCategory")

  @@index([parentId], map: "idx_category_parent")
  @@index([resourceType, resourceId], map: "idx_category_resource")
}

model Posts {
  id        Int      @id @default(autoincrement())
  pid       String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  postName  String   @unique
  postDesc  String?
  grant     Json?    @db.Json
  config    Json?    @db.Json
  status    String?  @db.VarChar(45)

  @@index([status], map: "idx_posts_status")
}

model Permission {
  id           Int               @id @default(autoincrement())
  action       String
  subjectType  PermissionSubject
  subjectId    Int?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  resourceId   Int               @default(0)
  resourceType String            @default("unknown")

  @@index([resourceType, resourceId], map: "idx_permission_resource")
  @@index([subjectType, subjectId], map: "idx_permission_subject")
}

model Comment {
  id             Int       @id @default(autoincrement())
  uuid           String    @unique @default(cuid())
  content        String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  documentId     Int
  userId         Int?
  authorName     String?   @db.VarChar(45)
  authorPassword String?   @db.VarChar(255)
  parentId       Int?
  isDeleted      Boolean   @default(false)
  isSecret       Boolean   @default(false)
  voteCount      Int       @default(0)
  depth          Int       @default(0)
  document       Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  parent         Comment?  @relation("CommentChildren", fields: [parentId], references: [id])
  children       Comment[] @relation("CommentChildren")
  user           User?     @relation(fields: [userId], references: [id])

  @@index([documentId], map: "idx_comment_document")
  @@index([userId], map: "idx_comment_user")
  @@index([parentId], map: "idx_comment_parent")
}

model DocumentViewLog {
  id         Int      @id @default(autoincrement())
  documentId Int
  userId     Int?
  ipAddress  String?
  viewedAt   DateTime @default(now())

  @@index([documentId, userId])
  @@index([documentId, ipAddress])
}

model Attachment {
  id           Int       @id @default(autoincrement())
  uuid         String    @unique @default(cuid())
  fileName     String
  originalName String
  mimeType     String
  size         Int
  path         String // 실제 저장 경로: /uploads/posts/... 등
  resourceId   Int // 게시글, 유저, 스토어 등 리소스 ID
  documentId   Int?
  resourceType String // posts, users, store, shop 등
  tempId       String? // ✨ 임시 파일 식별자
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  userId       Int? // 업로더 User ID
  uploadedBy   User?     @relation(fields: [userId], references: [id])
  document     Document? @relation(fields: [documentId], references: [id])

  @@index([resourceType, resourceId], map: "idx_attachment_resource")
  @@index([userId], map: "idx_attachment_user")
}


// 1. 주류 카테고리 (와인, 위스키, 맥주 등)
model DrinkCategory {
  id        Int             @id @default(autoincrement())
  name_ko      String          @unique // 카테고리 이름
  name_en      String          @unique // 카테고리 이름
  iso_code      String          @unique // 분류 코드
  continent      String          // 분류 코드
  flag_path      String          // 분류 코드
  status      String          // 분류 코드
}

// 2. 생산 국가
model DrinkCountry {
  id        Int             @id @default(autoincrement())
  name      String          @unique
  isoCode   String?         @unique // ISO 국가 코드 (예: KR, US)
  producers DrinkProducer[]
  beverages DrinkBeverage[]
}

// 3. 제조사/증류소
model DrinkProducer {
  id        Int             @id @default(autoincrement())
  name      String
  countryId Int
  country   DrinkCountry    @relation(fields: [countryId], references: [id])
  beverages DrinkBeverage[]
  createdAt DateTime        @default(now())
}

// 4. 주류 제품 메인 (핵심 테이블)
model DrinkBeverage {
  id          Int            @id @default(autoincrement())
  name        String         // 제품명
  categoryId  Int
  countryId   Int
  producerId  Int
  abv         Float          // 도수 (Alcohol by Volume)
  volume      Int?           // 용량 (ml)
  description String?        @db.Text
  imageUrl    String?
  
  // 주종별 가변 데이터 (예: 와인의 빈티지, 위스키의 숙성연수 등)
  specData    Json?          // PostgreSQL의 JSONB 타입을 활용한 확장 필드

  category    DrinkCategory  @relation(fields: [categoryId], references: [id])
  country     DrinkCountry   @relation(fields: [countryId], references: [id])
  producer    DrinkProducer  @relation(fields: [producerId], references: [id])
  
  tastings    DrinkTasting[]
  priceLogs   DrinkPrice[]
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

// 5. 시음 노트
model DrinkTasting {
  id         Int           @id @default(autoincrement())
  beverageId Int
  userId     Int           // 작성자 (기존 User 모델과 연결 가능)
  rating     Float         // 평점
  nose       String?       @db.Text // 향
  palate     String?       @db.Text // 맛
  finish     String?       @db.Text // 여운
  note       String?       @db.Text // 종합 메모
  
  beverage   DrinkBeverage @relation(fields: [beverageId], references: [id])
  createdAt  DateTime      @default(now())
}

// 6. 가격 로그 (구매 기록)
model DrinkPrice {
  id         Int           @id @default(autoincrement())
  beverageId Int
  price      Int           // 구매 가격
  currency   String        @default("KRW")
  shopName   String?       // 구매처
  boughtAt   DateTime?     // 구매 날짜
  beverage   DrinkBeverage @relation(fields: [beverageId], references: [id])
  createdAt  DateTime      @default(now())
}


enum PermissionSubject {
  guest
  member
  admin
  group
}
